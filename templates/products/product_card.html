{% load static %}
{% load i18n %}
{% load cart_filters %}

<div class="product-card">
    <!-- Product Image -->
    <div class="product-image-wrapper">
        <a href="{% url 'products:detail' slug=product.slug %}">
            {% if product.images.first %}
            <img src="{{ product.images.first.image.url }}" class="product-image" alt="{{ product.name }}">
            {% else %}
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                <i class="bi bi-image" style="font-size: 64px; color: var(--text-muted);"></i>
            </div>
            {% endif %}
        </a>

        <!-- Badges -->
        {% if product.discount_percentage > 0 %}
        <span class="product-badge sale">
            -{{ product.discount_percentage }}%
        </span>
        {% elif product.is_new %}
        <span class="product-badge new">
            {% trans 'New' %}
        </span>
        {% endif %}

        <!-- Favorite Button -->
        {% if request.user.is_authenticated %}
        <button class="product-favorite like-btn" 
                data-product-id="{{ product.id }}">
            <i class="bi bi-heart"></i>
        </button>
        {% else %}
        <button class="product-favorite" onclick="window.location.href='{% url 'users:login' %}?next={{ request.path }}'">
            <i class="bi bi-heart"></i>
        </button>
        {% endif %}
    </div>

    <!-- Product Info -->
    <div class="product-info">
        <div class="product-category">{{ product.category.name }}</div>
        
        <a href="{% url 'products:detail' slug=product.slug %}" class="text-decoration-none">
            <h3 class="product-title">{{ product.name }}</h3>
        </a>

        <!-- Rating -->
        <div class="product-rating">
            <span class="rating-stars">
                {% with rating=product.average_rating %}
                {% if rating > 0 %}
                    {% for i in "12345" %}
                        {% if forloop.counter|add:"0" <= rating|floatformat:"0" %}
                        <i class="bi bi-star-fill"></i>
                        {% elif forloop.counter|add:"-1"|add:"0" < rating and rating < forloop.counter|add:"0" %}
                        <i class="bi bi-star-half"></i>
                        {% else %}
                        <i class="bi bi-star"></i>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    {% for i in "12345" %}
                    <i class="bi bi-star"></i>
                    {% endfor %}
                {% endif %}
                {% endwith %}
            </span>
            <span class="rating-count">({{ product.review_count }})</span>
        </div>

        <!-- Price -->
        <div class="product-price-wrapper">
            {% if product.discount_percentage > 0 %}
            <span class="product-price">{{ product.discounted_price|format_price:current_currency }}</span>
            <span class="product-old-price">{{ product.price|format_price:current_currency }}</span>
            {% else %}
            <span class="product-price">{{ product.price|format_price:current_currency }}</span>
            {% endif %}
        </div>

        <!-- Installment -->
        {% if product.price > 100000 %}
        <div class="product-installment">
            <i class="bi bi-credit-card"></i> {% trans 'From' %} {{ product.price|floatformat:0|add:"0"|slice:":-3" }}/{% trans 'month' %}
        </div>
        {% endif %}

        <!-- Add to Cart Button -->
        <div class="product-actions">
            {% if product.is_in_stock %}
                {% if request.user.is_authenticated %}
                <form method="post" action="{% url 'cart:add' product_id=product.id %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="quantity" value="1">
                    <button type="submit" class="btn-add-cart">
                        <i class="bi bi-cart-plus me-1"></i> {% trans 'Add to Cart' %}
                    </button>
                </form>
                {% else %}
                <a href="{% url 'users:login' %}?next={{ request.path }}" class="btn-add-cart">
                    <i class="bi bi-box-arrow-in-right me-1"></i> {% trans 'Login to Buy' %}
                </a>
                {% endif %}
            {% else %}
            <button class="btn-add-cart" disabled>
                {% trans 'Out of Stock' %}
            </button>
            {% endif %}
        </div>
    </div>
</div>